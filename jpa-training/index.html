<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=//gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.80.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring Data JPA 培训实战 &#183; Heis</title><link type=text/css rel=stylesheet href=https://huangzhiyi.github.io/css/heis-min.css?20210401-3><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?f58b6a2675cf52000232edb4d109eccc";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed2.png><link rel="shortcut icon" href=/favicon2.png></head><body><aside class=sidebar id=bsidebar><button id=hide-sb-btn onclick=hideSidebar()></button><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://huangzhiyi.github.io/><h1 id=side-title>Heis</h1></a><p class=lead>Long live MAMBA</p><p><a href=https://wj.qq.com/s2/8270903/0413/ target=_blank><img class=feedbackqr src=/feedback.png></a></p><p class=ac><a href=https://wj.qq.com/s2/8270903/0413/ target=_blank>扫码给老师建议</a></p><p class=ac><script>document.write("heis"+"huangzy"+"@"+"qq"+".com")</script></p></div><nav><ul class=sidebar-nav><li><a href=https://huangzhiyi.github.io/>首页</a></li><li><a href=https://huangzhiyi.github.io/categories/hadoop/>Hadoop 部署与开发</a></li><li><a href=https://huangzhiyi.github.io/categories/iotdev/>物联网云平台开发相关»</a></li><li><a href=https://huangzhiyi.github.io/categories/hadoop-training/>Hadoop 实战»</a></li><li><a href=https://huangzhiyi.github.io/categories/spark/>Spark课程相关»</a></li><li><a href=https://huangzhiyi.github.io/categories>文章分类»</a></li><li><a href=https://huangzhiyi.github.io/tags>文章标签»</a></li></ul></nav><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container" id=mainpanel><button id=show-sb-btn onclick=showSidebar()></button>
<script src=https://huangzhiyi.github.io/js/jquery-min.js></script><div class=post><h1>Spring Data JPA 培训实战</h1><time datetime=2020-05-14T10:42:51+0800 class=post-date>2020-05-14</time><blockquote><h2>文章导航</h2><aside><nav id=TableOfContents><ul><li><a href=#版本>【版本】</a></li><li><a href=#实验1jpa-开发前准备>实验1：JPA 开发前准备</a><ul><li><a href=#实验名称>【实验名称】</a></li><li><a href=#实验目的>【实验目的】</a></li><li><a href=#实验原理>【实验原理】</a></li><li><a href=#实验环境>【实验环境】</a></li><li><a href=#实验资源>【实验资源】</a></li><li><a href=#实验步骤>【实验步骤】</a></li></ul></li><li><a href=#实验2使用-jpa-开发一个登录功能>实验2：使用 JPA 开发一个登录功能</a><ul><li><a href=#实验名称-1>【实验名称】</a></li><li><a href=#实验目的-1>【实验目的】</a></li><li><a href=#实验原理-1>【实验原理】</a></li><li><a href=#实验环境-1>【实验环境】</a></li><li><a href=#实验资源-1>【实验资源】</a></li><li><a href=#实验步骤-1>【实验步骤】</a></li></ul></li><li><a href=#实验3实现昵称和用户名皆可登录>实验3：实现昵称和用户名皆可登录</a><ul><li><a href=#实验名称-2>【实验名称】</a></li><li><a href=#实验目的-2>【实验目的】</a></li><li><a href=#实验原理-2>【实验原理】</a></li><li><a href=#实验环境-2>【实验环境】</a></li><li><a href=#实验要求>【实验要求】</a></li><li><a href=#实验提示>【实验提示】</a></li></ul></li><li><a href=#实验4flyway-实现-sql-脚本迁移>实验4：Flyway 实现 SQL 脚本迁移</a><ul><li><a href=#实验名称-3>【实验名称】</a></li><li><a href=#实验目的-3>【实验目的】</a></li><li><a href=#实验原理-3>【实验原理】</a></li><li><a href=#实验环境-3>【实验环境】</a></li><li><a href=#实验步骤-2>【实验步骤】</a></li></ul></li></ul></nav></aside></blockquote><p><a href=/ruiyi2020-summary target=_blank>往期培训资料汇总</a></p><h2 id=版本>【版本】</h2><p>当前版本号<code>v20200514</code></p><div class=tbl-start></div><table><thead><tr><th>版本</th><th>修改说明</th></tr></thead><tbody><tr><td>v20200514</td><td>初始化版本</td></tr></tbody></table><div class=tbl-end style=height:10px></div><h2 id=实验1jpa-开发前准备>实验1：JPA 开发前准备</h2><h3 id=实验名称>【实验名称】</h3><p>实验1：实验1：JPA 开发前准备</p><h3 id=实验目的>【实验目的】</h3><ul><li>清理数据库，并配置数据库环境</li><li>配置项目环境</li></ul><h3 id=实验原理>【实验原理】</h3><p>略</p><h3 id=实验环境>【实验环境】</h3><ul><li>操作系统: Windows系统。</li><li>IDEA</li><li>SpringBoot</li><li>MySQL 或 Mariadb</li><li>Maven</li><li>MySQL 客户端 （Navicat / HeidiSQL / MySQL Workbench 任意一种）</li></ul><h3 id=实验资源>【实验资源】</h3><ul><li>代码下载</li></ul><pre><code>https://pan.baidu.com/s/1wFq6u7PC8q1i0uh31esRbA#提取码luuu
</code></pre><h3 id=实验步骤>【实验步骤】</h3><ol><li>重新创建 test 数据库。使用 MySQL 客户端运行以下语句。</li></ol><pre><code>/* 查看 MySQL 版本 */
select version();

/* 删除 test 库 */
drop database if exists test;

/* 创建 test 库 */
create database if not exists test default charset utf8mb4 collate utf8mb4_general_ci;
</code></pre><blockquote><p>MySQL v5.5.3以后支持utf8mb4编码。utf8mb4是utf8的超集，utf8最多只支持长度为3字节的字符。utf8mb4编码专门用来兼容四字节的unicode，可以兼容包括 Emoji 表情，和很多不常用的汉字。</p></blockquote><p>MySQL 5.5.3以下可以使用UTF8编码。</p><pre><code>drop database if exists test;
create database if not exists test default charset utf8 collate utf8_general_ci;
</code></pre><ol start=2><li><p>导入项目 <code>demo_pro</code> 到 IDEA，过程略。</p></li><li><p>修改<code>src/main/resources/application-mysql.properties</code>文件相关配置，连接本地 MySQL 数据库的 test 数据库。</p></li></ol><pre><code>#validate   加载hibernate时，验证创建数据库表结构
#以下为危险操作，仅限用于开发初期阶段，不能在生产环境使用
#create     危险操作！每次加载hibernate，重新创建数据库表结构。
#create-drop   危险操作！加载hibernate时创建，退出是删除表结构
#update        危险操作！加载hibernate自动更新数据库结构

#这里暂时设置为update
spring.jpa.hibernate.ddl-auto=update
</code></pre><ol start=4><li><p>运行<code>src/main/java/com/ruiyi/demo/DemoApplication.java</code>，启动项目。</p></li><li><p>使用 MySQL 客户端观察 test 数据库是否产生新的表。</p></li></ol><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_13-50-43.png alt></p><ol start=6><li>导出test库下所有的表为 SQL 初始脚本。这里以MySQL 客户端 HeidiSQL 为例，其他客户端例如 MySQL Workbench 和 Navicat 也有相应的功能。</li></ol><blockquote><p>如果同学们不知道其他客户端如何导出 SQL 脚本，可以从实验资源获取<code>V001__init.sql</code>脚本。MySQL v5.5.3以下需要替换脚本内所有的 <code>utf8mb4</code> 为<code>utf8</code>。</p></blockquote><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_13-49-48.png alt></p><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_13-58-30.png alt></p><ol start=7><li><p>导出的脚本放置在项目<code>src/main/resources/db/migration/</code>目录下（没有这个目录就直接创建），文件名命名为 <code>V001__init.sql</code>。注意这个文件有2个连续的英文的下划线符号<code>_</code>。</p></li><li><p>修改<code>src/main/resources/application-mysql.properties</code></p></li></ol><pre><code>#这里修改为 validate
spring.jpa.hibernate.ddl-auto=validate
</code></pre><ol start=9><li>重新构建项目。
<img src=/static/img/jpatraining/Snipaste_2020-05-14_14-10-24.png alt></li></ol><hr><h2 id=实验2使用-jpa-开发一个登录功能>实验2：使用 JPA 开发一个登录功能</h2><h3 id=实验名称-1>【实验名称】</h3><p>实验2：使用 JPA 开发一个登录功能</p><h3 id=实验目的-1>【实验目的】</h3><ul><li>掌握如何实现数据库查询功能。</li></ul><h3 id=实验原理-1>【实验原理】</h3><p>略</p><h3 id=实验环境-1>【实验环境】</h3><ul><li>操作系统: Windows系统。</li><li>IDEA</li><li>SpringBoot</li><li>MySQL 或 Mariadb</li><li>Maven</li><li>MySQL 客户端 （Navicat / HeidiSQL / MySQL Workbench 任意一种）</li></ul><h3 id=实验资源-1>【实验资源】</h3><ul><li>代码下载</li></ul><pre><code>https://pan.baidu.com/s/1wFq6u7PC8q1i0uh31esRbA#提取码luuu
</code></pre><h3 id=实验步骤-1>【实验步骤】</h3><ol><li>观察 test 库下的 <code>user</code> 表。</li></ol><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_14-15-51.png alt></p><ol start=2><li><p>表中的 <code>password</code> 字段明文存储密码，这在真实的项目中是存在极大的安全隐患的，不值得提倡。所以我们这里需要修改<code>user</code>表存储密码的<code>Hash</code>（哈希值）。</p></li><li><p>经过考虑，我们会对<code>user</code>表执行以下操作。</p></li></ol><div class=tbl-start></div><table><thead><tr><th>列</th><th>操作</th><th>说明</th></tr></thead><tbody><tr><td>password</td><td>删除</td><td>不能明文存储密码</td></tr><tr><td>hash</td><td>新增</td><td>存储密码的哈希值</td></tr><tr><td>salt</td><td>新增</td><td>盐，可以混淆和增强密码的复杂度</td></tr><tr><td>nickname</td><td>新增</td><td>用户昵称</td></tr></tbody></table><div class=tbl-end style=height:10px></div><ol start=4><li>如果我们直接修改<code>User</code>这个 Model，虽然使用 JPA 会在数据库重新生成新的 User 表，但是这样我们很难维持开发库、测试库和生产库的一致性。所以我们使用递增的SQL 脚本的方式来处理数据库的变更。</li></ol><p>创建一个新的 SQL 脚本，<code>src/main/resources/db/migration/V002__change_user.sql</code>，内容如下。</p><pre><code>alter table user add column hash varchar(80) not null comment '哈希值';
alter table user add column salt varchar(10) not null comment '盐';
alter table user add column nickname varchar(50) not null comment '昵称';
alter table user drop column password;

</code></pre><ol start=5><li><p>使用 MySQL 客户端执行以上脚本。</p></li><li><p>重新构建项目以后，会发现项目报错。这是因为我们修改了数据库，而此时<code>spring.jpa.hibernate.ddl-auto</code>选项值是 validate，只校验但是不会做变更。</p></li></ol><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_14-48-23.png alt></p><ol start=7><li>我们可以修改<code>com.ruiyi.demo.model.User</code> 如以下所示。</li></ol><pre><code>package com.ruiyi.demo.model;

import lombok.Data;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Table;

@Data
@Entity
public class User extends BaseEntity {

    @Column(columnDefinition = &quot;varchar(100) COMMENT '用户名'&quot;)
    private String username;

    @Column(columnDefinition = &quot;varchar(80) COMMENT '哈希值'&quot;)
    private String hash;

    @Column(columnDefinition = &quot;varchar(10) COMMENT '盐'&quot;)
    private String salt;

    @Column(columnDefinition = &quot;varchar(50) COMMENT '昵称'&quot;)
    private String nickname;

    @Column(columnDefinition = &quot;smallint(2) DEFAULT '0' COMMENT '用户是否正常（1:不可用 0:正常）默认为0'&quot;)
    private Integer enabled;

}

</code></pre><ol start=8><li><p>重新构建项目，观察控制台是否还有报错。</p></li><li><p>新增加密类，用于计算密码哈希值。在 pom.xml 文件加入shiro依赖。</p></li></ol><pre><code>&lt;dependencies&gt;
...
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;
        &lt;artifactId&gt;shiro-core&lt;/artifactId&gt;
        &lt;version&gt;1.5.3&lt;/version&gt;
    &lt;/dependency&gt;
...
&lt;/dependencies&gt;
</code></pre><ol start=10><li>在实验资源中找到<code>CryptoUtil.java</code>和<code>CryptoUtilTestcase.java</code>。分别放到项目以下对应目录（如果目录不存在则创建）。这里注意要把src/test这个目录，在IDEA下标注为<code>Test Sources Root</code>。</li></ol><pre><code>#加密工具类
src/main/java/com/ruiyi/demo/utils/CryptoUtil.java

#加密工具类的测试用例
src/test/com/ruiyi/demo/utils/CryptoUtilTestcase.java
</code></pre><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_22-45-26.png alt></p><ol start=11><li>运行CryptoUtilTestcase，会输出一个用户经过哈希计算的密码哈希值。</li></ol><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_15-56-08.png alt></p><ol start=12><li>MySQL 客户端运行以下 SQL 脚本，插入一个用户</li></ol><pre><code>INSERT INTO `user` (`id`, `enabled`, `username`, `hash`, `salt`, `nickname`) VALUES (1, 1, 'john', '553628bbec1d6d06a82113eb67a4662a0812f92d90e142a0aa2d27db5e068d6f', 'iJycGK9', 'JohnWick');
</code></pre><ol start=13><li>修改 Service 层的代码。</li></ol><p><code>src/main/java/com/ruiyi/demo/service/UserService.java</code> 新增<code>findUserByUsername</code>方法。</p><pre><code>public interface UserService&lt;T&gt; extends BaseService&lt;T&gt; {
    void deletByIdList(List&lt;Integer&gt; idList);
    Page&lt;T&gt; search(String searchColumns, Map&lt;String, Object&gt; params);

    T findUserByUsername(String username);
}

</code></pre><p><code>src/main/java/com/ruiyi/demo/service/impl/UserServiceImpl.java</code></p><pre><code>    //增加此方法
    @Override
    public User findUserByUsername(String username){
        return iRepository.findFirstByUsername(username);
    }
</code></pre><ol start=14><li>修改<code>com.ruiyi.demo.rest.SignInController</code>，增加<code>UserService</code>和修改<code>signInSyn</code>方法。</li></ol><pre><code>import org.springframework.beans.factory.annotation.Autowired;

@RestController
@RequestMapping(value = {&quot;/&quot;})
public class SignInController {

    @Autowired
    private UserService&lt;User&gt; userService;

    @PostMapping(value = { &quot;/signInSyn&quot; }, produces= MediaType.TEXT_HTML_VALUE)
    public String signInSyn(String username,String pwd){
        User u=userService.findUserByUsername(username);
        if(u!=null){
            if(u.getHash().equals(CryptoUtil.hashWithSalt(pwd,u.getSalt()))){
                return&quot;&lt;h1&gt;&quot;+username+&quot;登录成功！&lt;/h1&gt;&quot;;
            }else {
                return &quot;&lt;h1&gt;&quot; + username + &quot;密码不正确&lt;/h1&gt;&quot;;
            }
        }else{
            return &quot;&lt;h1&gt;登录失败，请检查用户名和密码是否正确！&lt;/h1&gt;&quot;;
        }
    }

}
</code></pre><ol start=14><li>访问 <a href=http://localhost:9966/signIn target=_blank>http://localhost:9966/signIn</a> ，尝试使用以下账号登录，观察登录的结果。</li></ol><pre><code>用户名：john
密码：john#2020
</code></pre><hr><h2 id=实验3实现昵称和用户名皆可登录>实验3：实现昵称和用户名皆可登录</h2><h3 id=实验名称-2>【实验名称】</h3><p>实验3：实现昵称和用户名皆可登录</p><h3 id=实验目的-2>【实验目的】</h3><ul><li>实现昵称和用户名皆可登录</li></ul><h3 id=实验原理-2>【实验原理】</h3><p>略</p><h3 id=实验环境-2>【实验环境】</h3><ul><li>操作系统: Windows系统。</li><li>IDEA</li><li>SpringBoot</li><li>MySQL 或 Mariadb</li><li>Maven</li><li>MySQL 客户端 （Navicat / HeidiSQL / MySQL Workbench 任意一种）</li></ul><h3 id=实验要求>【实验要求】</h3><ol><li><p>用户在登录界面，用户名一栏输入<code>用户名</code>或者<code>昵称</code>，如果密码正确都可以成功登录。</p></li><li><p>在<code>com.ruiyi.demo.repository.UserRepository</code> 新增一个方法<code>findFirstByUsernameOrNickname(String name)</code>，可以通过用户名或昵称查询到用户。</p></li><li><p>使用以下用户名和密码登录<a href=http://localhost:9966/signIn target=_blank>http://localhost:9966/signIn</a> ，能够登录成功。</p></li></ol><pre><code>用户名：JohnWick
密码：john#2020
</code></pre><h3 id=实验提示>【实验提示】</h3><p>请先思考再查看提示：</p><p>提示开始（鼠标选中以下空白区域会显示提示。）</p><div style=color:#fff>1. findFirstByUsernameOrNickname 方法代码<p>@Query(&ldquo;from User a where username=:name or nickname=:name&rdquo;)</p><p>User findFirstByUsernameOrNickname(String name);</p></div>提示结束<hr><h2 id=实验4flyway-实现-sql-脚本迁移>实验4：Flyway 实现 SQL 脚本迁移</h2><h3 id=实验名称-3>【实验名称】</h3><p>实验4：Flyway 实现 SQL 脚本迁移</p><h3 id=实验目的-3>【实验目的】</h3><ul><li>掌握 Flyway 的基本使用和原理</li></ul><h3 id=实验原理-3>【实验原理】</h3><p>略</p><h3 id=实验环境-3>【实验环境】</h3><ul><li>操作系统: Windows系统。</li><li>IDEA</li><li>SpringBoot</li><li>MySQL 或 Mariadb</li><li>Maven</li><li>MySQL 客户端 （Navicat / HeidiSQL / MySQL Workbench 任意一种）</li><li>Flyway 配置 POM 依赖</li></ul><h3 id=实验步骤-2>【实验步骤】</h3><ol><li>打开项目 pom.xml 文件，在plugins 标签内添加 Flyway 插件内容。注意修改你的root密码和 MySQL 驱动包的版本。5.x可以配置5.1.48，8.x可以配置为 8.0.20。</li></ol><pre><code>&lt;plugins&gt;
...
    &lt;plugin&gt;
        &lt;groupId&gt;org.flywaydb&lt;/groupId&gt;
        &lt;artifactId&gt;flyway-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;6.4.2&lt;/version&gt;
        &lt;configuration&gt;
            &lt;driver&gt;com.mysql.jdbc.Driver&lt;/driver&gt;
            &lt;url&gt;jdbc:mysql://localhost:3306/test&lt;/url&gt;
            &lt;user&gt;root&lt;/user&gt;
            &lt;password&gt;你的root密码&lt;/password&gt;
        &lt;/configuration&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;mysql&lt;/groupId&gt;
                &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
                &lt;version&gt;驱动版本&lt;/version&gt;
                &lt;scope&gt;runtime&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/plugin&gt;
    ...
&lt;/plugins&gt;
</code></pre><ol start=2><li>之前的实验已经创建了2个版本的脚本。Flyway 默认查找脚本执行的路径是在<code>src/main/resources/db/migration/</code>。</li></ol><pre><code>src/main/resources/db/migration/V001__init.sql
src/main/resources/db/migration/V002__change_user.sql
</code></pre><ol start=3><li>使用MySQL 客户端执行以下 SQL 语句，清空MySQL的 test 库。</li></ol><p>v5.5.3及以后版本</p><pre><code>drop database if exists test;

/* 创建 test 库 */
create database if not exists test default charset utf8mb4 collate utf8mb4_general_ci;
</code></pre><p>v5.5.3以前版本</p><pre><code>drop database if exists test;
create database if not exists test default charset utf8 collate utf8_general_ci;
</code></pre><ol start=4><li>打开 IDEA 的 Terminal 窗口，运行以下语句，看看数据库的表有没有恢复。</li></ol><pre><code>mvn flyway:migrate
</code></pre><p><img src=/static/img/jpatraining/Snipaste_2020-05-14_22-46-51.png alt></p></div><button id=scroll-top-btn>↑顶部</button><div id=outerdiv style=position:fixed;top:0;left:0;background:rgba(0,0,0,.7);z-index:2;width:100%;height:100%;display:none><div id=innerdiv style=position:absolute><img id=bigimg style="border:5px solid #fff" src></div><script src=https://huangzhiyi.github.io/js/highlight.pack.js></script><script src=https://huangzhiyi.github.io/js/clipboard.min.js></script><script src=https://huangzhiyi.github.io/js/highlightjs-line-numbers.min.js></script><script>hljs.initHighlightingOnLoad();hljs.initLineNumbersOnLoad();$(function(){$('div.tbl-start').nextUntil('div.tbl-end','table').addClass('tbl');$("img").click(function(){var _this=$(this);imgShow("#outerdiv","#innerdiv","#bigimg",_this);});$("#scroll-top-btn").click(function(){document.body.scrollTop=document.documentElement.scrollTop=0;});});</script></main><script src=https://huangzhiyi.github.io/js/jquery-min.js></script><script src=https://huangzhiyi.github.io/js/heis-custom-min.js?210610></script></body></html>