<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=//gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.80.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>商务智能方法与应用第二章实验手册 &#183; Heis</title><link type=text/css rel=stylesheet href=https://huangzhiyi.github.io/css/heis-min.css?578><link type=text/css id=dark_theme_css rel=stylesheet href=https://huangzhiyi.github.io/css/a11y-dark.css title=dark><link type=text/css id=light_theme_css rel="alternate stylesheet" href=https://huangzhiyi.github.io/css/a11y-light.css title=light><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?f58b6a2675cf52000232edb4d109eccc";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed2.png><link rel="shortcut icon" href=/favicon2.png><script src=https://huangzhiyi.github.io/js/jquery-min.js></script></head><body><aside class=sidebar id=bsidebar><button id=hide-sb-btn onclick=hideSidebar()></button><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://huangzhiyi.github.io/><h1 id=side-title>Heis</h1></a><p class=lead>Long live MAMBA</p><p class=ac><a href=https://support.qq.com/products/332688 class=tooltip target=_blank><img class=tooltiptext src=https://huangzhiyi.github.io/feedback.png?20210617>
提点意见和建议»</a></p></div><nav><ul class=sidebar-nav><li><a href=https://huangzhiyi.github.io/>首页</a></li><li><a href=https://huangzhiyi.github.io/categories/javaweb/>Java后台应用项目开发»</a></li><li><a href=https://huangzhiyi.github.io/categories/clouddc/>云数据中心基础»</a></li><li><a href=https://huangzhiyi.github.io/categories/webtraining/>Web企业级项目实战»</a></li><li><a href=https://huangzhiyi.github.io/categories>文章分类»</a></li><li><a href=https://huangzhiyi.github.io/tags>文章标签»</a></li><li><a href=https://heis.gitee.io/ target=_blank>镜像0：heis.gitee.io</a></li><li><a href=http://heisun.xyz/ target=_blank>镜像1：heisun.xyz</a></li><li><a href=https://huangzhiyi.github.io/ target=_blank>镜像2：huangzhiyi.github.io</a></li></ul></nav><p>&copy; 2021. All rights reserved.</p><p></p></div></aside><main class="content container" id=mainpanel><button id=show-sb-btn onclick=showSidebar()></button><div class=post><h1>商务智能方法与应用第二章实验手册</h1><time datetime=2020-02-09T10:42:51+0800 class=post-date>2020-02-09</time><blockquote><h2>文章导航</h2><aside><nav id=TableOfContents><ul><li><a href=#实验手册版本>【实验手册版本】</a></li><li><a href=#实验21hive-数据仓库的建立和分析>实验2.1：Hive 数据仓库的建立和分析</a><ul><li><a href=#实验名称>【实验名称】</a></li><li><a href=#实验目的>【实验目的】</a></li><li><a href=#实验原理>【实验原理】</a></li><li><a href=#实验环境>【实验环境】</a></li><li><a href=#实验资源>【实验资源】</a></li><li><a href=#hive优化参数配置和解决常见问题>【Hive优化参数配置和解决常见问题】</a></li><li><a href=#实验步骤>【实验步骤】</a></li></ul></li></ul></nav></aside></blockquote><p><a href=/bi-summary/>«返回课程汇总页面</a></p><h2 id=实验手册版本>【实验手册版本】</h2><p>当前版本号<code>v20200330</code></p><div class=tbl-start></div><table><thead><tr><th>版本</th><th>修改说明</th></tr></thead><tbody><tr><td>v20200330</td><td>增加了 Hive 优化参数</td></tr><tr><td>v20200325</td><td>第10步第（4）小题增加了提示</td></tr><tr><td>v20200323</td><td>更正实验第10步第（3）小题错误</td></tr><tr><td>v20200228</td><td>初始化版本</td></tr></tbody></table><div class=tbl-end style=height:10px></div><h2 id=实验21hive-数据仓库的建立和分析>实验2.1：Hive 数据仓库的建立和分析</h2><h3 id=实验名称>【实验名称】</h3><p>Hive 数据仓库的建立</p><h3 id=实验目的>【实验目的】</h3><ul><li>1．熟悉 Linux、MySQL、Hive、HDFS 等系统和软件的安装和使用。</li><li>2．了解建立数据仓库的基本流程。</li><li>3．熟悉数据预处理方法。</li></ul><h3 id=实验原理>【实验原理】</h3><p>数据仓库（Data Warehouse）是一个面向主题的（Subject Oriented）、集成的（Integrated）、相对稳定的（Non-Volatile）、反映历史变化（Time Variant）的数据集合，用于支持管理决策。</p><p>Hive 是一个构建于 Hadoop 顶层的数据仓库工具，支持大规模数据存储、分析，具有良好的可扩展性。某种程度上可以将 Hive 看作是用户编程接口。Hive 本身不存储和处理数据，依赖分布式文件系统 HDFS 存储数据，依赖分布式并行计算模型MapReduce 处理数据。Hive 定义了简单的类似 SQL 的查询语言——HiveQL。用户可以通过编写的 HiveQL 语句运行 MapReduce 任务，可以很容易把原来构建在关系数据库上的数据仓库应用程序移植到 Hadoop 平台上。Hive 是一个可以有效、合理、直观的数据分析工具。</p><h3 id=实验环境>【实验环境】</h3><ul><li>1．Ubuntu 16.04 操作系统；</li><li>2．Hadoop；</li><li>3．Hive。</li></ul><blockquote><p>提示：可以使用 Spark 课程的<a href=/spark-exp02/>虚拟机镜像</a>完成。或者使用之前 Hadoop课程的<a href=/hadoop-exp02/>虚拟机镜像</a>。</p></blockquote><h3 id=实验资源>【实验资源】</h3><p>实验报告模板下载</p><pre><code>https://pan.baidu.com/s/1qqhcPcQotylS3PNP4f-edg#提取码vidt
</code></pre><p>实验数据</p><pre><code>https://pan.baidu.com/s/1leU7OjPBmX0h_QV3N8ZeRw#提取码u4sq
</code></pre><h3 id=hive优化参数配置和解决常见问题>【Hive优化参数配置和解决常见问题】</h3><ol><li>解决<code>Unable to instantiate org.apache.hadoop.hive.ql.metadata.SessionHiveMetaStoreClient</code>问题。</li></ol><p>这通常是由于 Hive 的 MetaStore Server校验 Schema 出错导致的。只需要关闭校验选项即可。找到Hive安装目录/conf/hive-site.xml，增加以下选项配置。</p><pre><code>&lt;property&gt;
     &lt;name&gt;hive.metastore.schema.verification&lt;/name&gt;
     &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;
</code></pre><ol start=2><li>优化 Hive 执行卡顿的参数配置。启动 Hive 以后，可以在 Hive 终端执行以下参数设置，优化运行效率。</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#100%执行完 map 再执行 reduce，避免运行 map 同时又运行 reduce，占用太多资源。</span>
hive&gt;set mapreduce.job.reduce.slowstart.completedmaps<span style=color:#f92672>=</span>1.0;

<span style=color:#75715e># 设置 mapreduce 执行内存为 2048MB，可视虚拟机资源情况自行调整。</span>
hive&gt;set mapreduce.map.memory.mb<span style=color:#f92672>=</span>2048;

<span style=color:#75715e># 设置 mapreduce CPU 执行核数为2，可视虚拟机资源情况自行调整。</span>
hive&gt;set mapreduce.map.cpu.vcores<span style=color:#f92672>=</span>2;
</code></pre></div><ol start=3><li>使用 Hive 日志进行错误诊断。</li></ol><p>Hive 的日志默认是在<code>/tmp/{用户名}/hive.log</code>。如果是使用Node0虚拟机镜像的Hadoop用户，则是在<code>/tmp/hadoop/hive.log</code>。</p><p>如果需要调整 hive 的日志路径，可以在<code>Hive安装目录/conf/</code>下修改日志配置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cp hive-exec-log4j2.properties.template hive-exec-log4j2.properties

vim hive-exec-log4j2.properties
</code></pre></div><p>修改<code>property.hive.log.dir</code>选项</p><pre><code>#property.hive.log.dir = ${sys:java.io.tmpdir}/${sys:user.name}
property.hive.log.dir = /opt/hive/logs
</code></pre><h3 id=实验步骤>【实验步骤】</h3><blockquote><p>实验须知：本实验默认使用 Spark 课程虚拟机镜像完成，可能个别命令与你环境有区别，请注意识别。</p></blockquote><ol><li>启动 Hadoop，如果使用其他镜像可以使用<code>start-all.sh</code>启动。</li></ol><pre><code>start-hdp.sh
</code></pre><ol start=2><li>检查 Hadoop 是否正常启动，必须具有以下进程。</li></ol><pre><code>DataNode
ResourceManager
Jps
NodeManager
NameNode
SecondaryNameNode
</code></pre><ol start=3><li><p>从上文实验资源链接下载实验数据文件<code>user_table.csv</code>，上传到<code>/home/hadoop</code>目录下。</p></li><li><p>把<code>user_table.csv</code>上传到HDFS目录<code>/biexp/001</code>，请注意替换001为你的学号最后三位。（关键步骤，如果没有此步骤实验报告不得分）</p></li></ol><pre><code>hdfs dfs -mkdir -p /biexp/001
hdfs dfs -put /home/hadoop/user_table.csv /biexp/001
</code></pre><ol start=5><li>查看是否成功上传文件</li></ol><pre><code>hadoop fs -ls /biexp/001
</code></pre><ol start=6><li>启动 Hive。</li></ol><pre><code>hive
</code></pre><ol start=7><li>在 Hive 命令行终端输入以下命令，创建数据库。请注意替换001为你的学号最后三位。</li></ol><pre><code>create database db001;
use db001;
</code></pre><ol start=8><li>创建外部表<code>user001</code>并导入数据。请注意替换以下语句中001为你的学号最后三位。</li></ol><pre><code>create external table db001.user001 (id INT, uid string, item_id string, behavior_type INT, user_geohash string, item_category string, visit_date DATE,province string) COMMENT 'Welcome to xmu dblab!' ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' STORED AS TEXTFILE LOCATION '/biexp/001/';
</code></pre><p>表列说明：</p><div class=tbl-start></div><table><thead><tr><th>列</th><th>注释</th></tr></thead><tbody><tr><td>id</td><td>自增ID</td></tr><tr><td>uid</td><td>用户ID</td></tr><tr><td>item_id</td><td>商品ID</td></tr><tr><td>behavior_type</td><td>操作类型；1表示查看浏览；2表示收藏；3表示加购物车；4表示购买</td></tr><tr><td>user_geohash</td><td>用户地理位置哈希值</td></tr><tr><td>item_category</td><td>商品目录</td></tr><tr><td>visit_date</td><td>用户操作日期</td></tr><tr><td>province</td><td>用户所在省份</td></tr></tbody></table><div class=tbl-end style=height:10px></div><ol start=9><li>查询user表，查看是否有数据。</li></ol><pre><code>select * from db001.user001 limit 10;
</code></pre><ol start=10><li>完成以下 HiveQL 语句。</li></ol><p>（1）查询所有用户加购物车的次数。</p><pre><code>#结果
8560
</code></pre><p>（2）查询江浙沪（zhejiang，jiangsu，shanghai）用户购买物品的次数总和。</p><pre><code>#结果
305
</code></pre><p>（3）查询全部省份用户浏览次数，按次数从高到低排序。</p><pre><code>#结果
shanxi	16490
xinjiang	8525
tianjin	8490
zhejiang	8488
guangxi	8456
guangdong	8451
shanghai	8442
beijing	8431
hebei	8424
xianggang	8391
anhui	8390
hainan	8389
helongjiang	8379
qinghai	8370
fujian	8368
aomen	8354
neimenggu	8351
hunan	8337
gansu	8335
jilin	8327
xizang	8323
guizhou	8319
henan	8311
shandong	8309
liaoning	8296
yunnan	8272
jiangsu	8261
chongqing	8258
ningxia	8246
taiwan	8241
hubei	8192
jiangxi	8152
sichuan	8148
</code></pre><p>（4）查询用户收藏过并且购买了的商品的数量。</p><pre><code>#结果
427
</code></pre><blockquote><p>提示1：可以使用user001自己和自己连接。</p></blockquote><blockquote><p>提示2：注意这里前提是同一个用户，收藏并且购买。</p></blockquote><blockquote><p>提示3：用户收藏且购买的相同商品数量有可能有多个。例如用户（uid=103234309）收藏且购买的商品（item_id=395194106）有3个。</p></blockquote><p>（5）查询广东（guangdong）购物数量最多的前10位用户的ID和购物数量，按数量从高到低排序。</p><pre><code>102612580	5
101970481	5
101922121	4
103995979	3
102616570	3
101982646	3
10095384	3
</code></pre></div><button id=scroll-top-btn>↑顶部</button>
<button id=switch-theme-btn>换主题</button><div id=outerdiv style=position:fixed;top:0;left:0;background:rgba(0,0,0,.7);z-index:2;width:100%;height:100%;display:none><div id=innerdiv style=position:absolute><img id=bigimg style="border:5px solid #fff" src></div></div><div id=category style=display:none;position:fixed;right:10px;bottom:10px;width:10em></div><script src=https://huangzhiyi.github.io/js/highlight.pack.js></script><script src=https://huangzhiyi.github.io/js/highlightjs-line-numbers.min.js></script><script>hljs.initHighlightingOnLoad();hljs.initLineNumbersOnLoad();$(function(){let curTheme=getCookie("theme");if(curTheme===""){setTheme("dark");}else{setTheme(curTheme);}
$('div.tbl-start').nextUntil('div.tbl-end','table').addClass('tbl');$("img").click(function(){var _this=$(this);imgShow("#outerdiv","#innerdiv","#bigimg",_this);});$("#scroll-top-btn").click(function(){document.body.scrollTop=document.documentElement.scrollTop=0;});$("#switch-theme-btn").click(function(){switchTheme();})});</script><script src=https://huangzhiyi.github.io/js/clipboard.min.js?></script><script src=https://huangzhiyi.github.io/js/codecopy.bundle.js?400></script></main><script src=https://huangzhiyi.github.io/js/heis-custom-min.js?479></script></body></html>