<!doctype html><html lang=zh><meta charset=utf-8><meta name=viewport content="width=device-width"><title>商务智能方法与应用第二章实验手册 | 商务智能课程资源汇总 | Heis</title><meta name=generator content="Hugo Eureka 0.8.4"><link rel=stylesheet href=/css/eureka.min.css><script defer src=/js/eureka.min.js></script><script src=/static/js/jquery-3.6.0.min.js></script><script src=/static/js/heis.js></script><link rel=stylesheet href=/static/css/heis.css media=all onload="this.media='all';this.onload=null" crossorigin><link rel=stylesheet href=/static/css/print.css media=print crossorigin><link rel=stylesheet href=/static/css/highlight-css/solarized-light.min.css media=print onload="this.media='all';this.onload=null" crossorigin><script defer src=/static/js/highlight.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script><script defer src=/static/js/highlightjs-line-numbers.min.js></script><link rel=icon type=image/png sizes=32x32 href=/images/icon_huddfe7d1590fd89155f46b33625956ea5_4357_32x32_fill_box_center_2.png><link rel=apple-touch-icon sizes=180x180 href=/images/icon_huddfe7d1590fd89155f46b33625956ea5_4357_180x180_fill_box_center_2.png><meta name=description content="商务智能方法与应用第二章实验手册"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"课程文档","item":"/docs/"},{"@type":"ListItem","position":2,"name":"商务智能课程资源汇总","item":"/docs/bi-exp/"},{"@type":"ListItem","position":3,"name":"商务智能方法与应用第二章实验手册","item":"/docs/bi-exp/bi-exp02/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/docs/bi-exp/bi-exp02/"},"headline":"商务智能方法与应用第二章实验手册 | 商务智能课程资源汇总 | Heis","datePublished":"2020-02-09T10:42:51+08:00","dateModified":"2020-02-09T10:42:51+08:00","wordCount":2098,"publisher":{"@type":"Person","name":"C. Wang","logo":{"@type":"ImageObject","url":"/images/icon.png"}},"description":"商务智能方法与应用第二章实验手册"}</script><meta property="og:title" content="商务智能方法与应用第二章实验手册 | 商务智能课程资源汇总 | Heis"><meta property="og:type" content="article"><meta property="og:image" content="/images/icon.png"><meta property="og:url" content="/docs/bi-exp/bi-exp02/"><meta property="og:description" content="商务智能方法与应用第二章实验手册"><meta property="og:locale" content="zh"><meta property="og:site_name" content="Heis"><meta property="article:published_time" content="2020-02-09T10:42:51+08:00"><meta property="article:modified_time" content="2020-02-09T10:42:51+08:00"><meta property="article:section" content="docs"><meta property="article:tag" content="商务智能"><meta property="article:tag" content="bi"><meta property="article:tag" content="课程"><meta property="og:see_also" content="/docs/bi-exp/bi-exp01/"><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?f58b6a2675cf52000232edb4d109eccc";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><body class="flex flex-col min-h-screen"><header id=headerctn class="fixed flex items-center w-full pl-scrollbar z-50 bg-secondary-bg shadow-sm"><div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode")
if(((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches)||storageColorScheme=="Dark"){document.getElementsByTagName('html')[0].classList.add('dark')}</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="mr-6 text-primary-text text-xl font-bold">Heis</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">文章</a>
<a href=/go class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">导航</a>
<a href=/docs/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">课程文档</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>浅色</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>深色</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>自动</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById('lightDarkMode')
if(storageColorScheme==null||storageColorScheme=='Auto'){document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)})}else if(storageColorScheme=="Light"){element.firstElementChild.classList.remove('fa-adjust')
element.firstElementChild.setAttribute("data-icon",'sun')
element.firstElementChild.classList.add('fa-sun')}else if(storageColorScheme=="Dark"){element.firstElementChild.classList.remove('fa-adjust')
element.firstElementChild.setAttribute("data-icon",'moon')
element.firstElementChild.classList.add('fa-moon')}
document.addEventListener('DOMContentLoaded',()=>{getcolorscheme();switchBurger();});</script></div></header><main class="flex-grow pt-16"><div class=pl-scrollbar><div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto"><div class=lg:pt-12><div class="flex flex-col md:flex-row bg-secondary-bg rounded"><div class="md:w-1/4 lg:w-1/5 border-r"><div class="sticky top-16 pt-6"><div id=sidebar-title class="md:hidden mx-4 px-2 pt-4 pb-2 md:border-b text-tertiary-text md:text-primary-text"><span class=font-semibold>目录</span>
<i class="fas fa-caret-right ml-1"></i></div><div id=sidebar-toc class="hidden md:block overflow-y-auto mx-6 md:mx-0 pr-6 pt-2 md:max-h-doc-sidebar bg-primary-bg md:bg-transparent"><div class="flex flex-wrap ml-4 -mr-2 p-2 bg-secondary-bg md:bg-primary-bg rounded"><a class=hover:text-eureka href=/docs/bi-exp/>商务智能课程资源汇总</a></div><ul class=pl-6><li class=py-2><div><a class=hover:text-eureka href=/docs/bi-exp/bi-training2/>商务智能方法与应用综合实验2</a></div></li><li class=py-2><div><a class=hover:text-eureka href=/docs/bi-exp/bi-training1-rs/>商务智能方法与应用综合实验1参考解决方法</a></div></li><li class=py-2><div><a class=hover:text-eureka href=/docs/bi-exp/bi-training1/>商务智能方法与应用综合实验1</a></div></li><li class=py-2><div><a class=hover:text-eureka href=/docs/bi-exp/bi-exp06/>商务智能方法与应用第六章实验手册</a></div></li><li class=py-2><div><a class=hover:text-eureka href=/docs/bi-exp/bi-exp04/>商务智能方法与应用第四章实验手册</a></div></li><li class=py-2><div><a class=hover:text-eureka href=/docs/bi-exp/bi-exp03/>商务智能方法与应用第三章实验手册</a></div></li><li class=py-2><div><a class="text-eureka hover:text-eureka" href=/docs/bi-exp/bi-exp02/>商务智能方法与应用第二章实验手册</a></div></li><li class=py-2><div><a class=hover:text-eureka href=/docs/bi-exp/bi-exp01/>商务智能方法与应用第一章实验手册</a></div></li></ul></div></div></div><div class="w-full md:w-3/4 lg:w-4/5 pb-8 pt-2 md:pt-8"><div class="w-full lg:w-3/4 pl-6 ml-0 mr-auto"><h1 class="font-bold text-3xl text-primary-text">商务智能方法与应用第二章实验手册</h1><div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text"><div class="mr-6 my-2"><i class="fas fa-calendar mr-1"></i><span>2020-02-09</span></div><div class="mr-6 my-2"><i class="fas fa-clock mr-1"></i><span>5分钟阅读时长</span></div><div class="mr-6 my-2"><i class="fas fa-folder mr-1"></i><a href=/categories/bi/ class=hover:text-eureka>bi</a></div></div></div><div class=flex><div class="w-full lg:w-3/4 px-6"><div class=content><p><a href=/bi-summary/>«返回课程汇总页面</a></p><h2 id=实验手册版本>【实验手册版本】</h2><p>当前版本号<code>v20200330</code></p><div class=tbl-start></div><table><thead><tr><th>版本</th><th>修改说明</th></tr></thead><tbody><tr><td>v20200330</td><td>增加了 Hive 优化参数</td></tr><tr><td>v20200325</td><td>第10步第（4）小题增加了提示</td></tr><tr><td>v20200323</td><td>更正实验第10步第（3）小题错误</td></tr><tr><td>v20200228</td><td>初始化版本</td></tr></tbody></table><div class=tbl-end style=height:10px></div><h2 id=实验21hive-数据仓库的建立和分析>实验2.1：Hive 数据仓库的建立和分析</h2><h3 id=实验名称>【实验名称】</h3><p>Hive 数据仓库的建立</p><h3 id=实验目的>【实验目的】</h3><ul><li>1．熟悉 Linux、MySQL、Hive、HDFS 等系统和软件的安装和使用。</li><li>2．了解建立数据仓库的基本流程。</li><li>3．熟悉数据预处理方法。</li></ul><h3 id=实验原理>【实验原理】</h3><p>数据仓库（Data Warehouse）是一个面向主题的（Subject Oriented）、集成的（Integrated）、相对稳定的（Non-Volatile）、反映历史变化（Time Variant）的数据集合，用于支持管理决策。</p><p>Hive 是一个构建于 Hadoop 顶层的数据仓库工具，支持大规模数据存储、分析，具有良好的可扩展性。某种程度上可以将 Hive 看作是用户编程接口。Hive 本身不存储和处理数据，依赖分布式文件系统 HDFS 存储数据，依赖分布式并行计算模型MapReduce 处理数据。Hive 定义了简单的类似 SQL 的查询语言——HiveQL。用户可以通过编写的 HiveQL 语句运行 MapReduce 任务，可以很容易把原来构建在关系数据库上的数据仓库应用程序移植到 Hadoop 平台上。Hive 是一个可以有效、合理、直观的数据分析工具。</p><h3 id=实验环境>【实验环境】</h3><ul><li>1．Ubuntu 16.04 操作系统；</li><li>2．Hadoop；</li><li>3．Hive。</li></ul><blockquote><p>提示：可以使用 Spark 课程的<a href=spark-exp02/>虚拟机镜像</a>完成。或者使用之前 Hadoop课程的<a href=hadoop-exp02/>虚拟机镜像</a>。</p></blockquote><h3 id=实验资源>【实验资源】</h3><p>实验报告模板下载</p><pre><code>https://pan.baidu.com/s/1qqhcPcQotylS3PNP4f-edg#提取码vidt
</code></pre><p>实验数据</p><pre><code>https://pan.baidu.com/s/1leU7OjPBmX0h_QV3N8ZeRw#提取码u4sq
</code></pre><h3 id=hive优化参数配置和解决常见问题>【Hive优化参数配置和解决常见问题】</h3><ol><li>解决<code>Unable to instantiate org.apache.hadoop.hive.ql.metadata.SessionHiveMetaStoreClient</code>问题。</li></ol><p>这通常是由于 Hive 的 MetaStore Server校验 Schema 出错导致的。只需要关闭校验选项即可。找到Hive安装目录/conf/hive-site.xml，增加以下选项配置。</p><pre><code>&lt;property&gt;
     &lt;name&gt;hive.metastore.schema.verification&lt;/name&gt;
     &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;
</code></pre><ol start=2><li>优化 Hive 执行卡顿的参数配置。启动 Hive 以后，可以在 Hive 终端执行以下参数设置，优化运行效率。</li></ol><pre><code class=language-shell>#100%执行完 map 再执行 reduce，避免运行 map 同时又运行 reduce，占用太多资源。
hive&gt;set mapreduce.job.reduce.slowstart.completedmaps=1.0;

# 设置 mapreduce 执行内存为 2048MB，可视虚拟机资源情况自行调整。
hive&gt;set mapreduce.map.memory.mb=2048;

# 设置 mapreduce CPU 执行核数为2，可视虚拟机资源情况自行调整。
hive&gt;set mapreduce.map.cpu.vcores=2;
</code></pre><ol start=3><li>使用 Hive 日志进行错误诊断。</li></ol><p>Hive 的日志默认是在<code>/tmp/{用户名}/hive.log</code>。如果是使用Node0虚拟机镜像的Hadoop用户，则是在<code>/tmp/hadoop/hive.log</code>。</p><p>如果需要调整 hive 的日志路径，可以在<code>Hive安装目录/conf/</code>下修改日志配置。</p><pre><code class=language-shell>cp hive-exec-log4j2.properties.template hive-exec-log4j2.properties

vim hive-exec-log4j2.properties
</code></pre><p>修改<code>property.hive.log.dir</code>选项</p><pre><code>#property.hive.log.dir = ${sys:java.io.tmpdir}/${sys:user.name}
property.hive.log.dir = /opt/hive/logs
</code></pre><h3 id=实验步骤>【实验步骤】</h3><blockquote><p>实验须知：本实验默认使用 Spark 课程虚拟机镜像完成，可能个别命令与你环境有区别，请注意识别。</p></blockquote><ol><li>启动 Hadoop，如果使用其他镜像可以使用<code>start-all.sh</code>启动。</li></ol><pre><code>start-hdp.sh
</code></pre><ol start=2><li>检查 Hadoop 是否正常启动，必须具有以下进程。</li></ol><pre><code>DataNode
ResourceManager
Jps
NodeManager
NameNode
SecondaryNameNode
</code></pre><ol start=3><li><p>从上文实验资源链接下载实验数据文件<code>user_table.csv</code>，上传到<code>/home/hadoop</code>目录下。</p></li><li><p>把<code>user_table.csv</code>上传到HDFS目录<code>/biexp/001</code>，请注意替换001为你的学号最后三位。（关键步骤，如果没有此步骤实验报告不得分）</p></li></ol><pre><code>hdfs dfs -mkdir -p /biexp/001
hdfs dfs -put /home/hadoop/user_table.csv /biexp/001
</code></pre><ol start=5><li>查看是否成功上传文件</li></ol><pre><code>hadoop fs -ls /biexp/001
</code></pre><ol start=6><li>启动 Hive。</li></ol><pre><code>hive
</code></pre><ol start=7><li>在 Hive 命令行终端输入以下命令，创建数据库。请注意替换001为你的学号最后三位。</li></ol><pre><code>create database db001;
use db001;
</code></pre><ol start=8><li>创建外部表<code>user001</code>并导入数据。请注意替换以下语句中001为你的学号最后三位。</li></ol><pre><code>create external table db001.user001 (id INT, uid string, item_id string, behavior_type INT, user_geohash string, item_category string, visit_date DATE,province string) COMMENT 'Welcome to xmu dblab!' ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' STORED AS TEXTFILE LOCATION '/biexp/001/';
</code></pre><p>表列说明：</p><div class=tbl-start></div><table><thead><tr><th>列</th><th>注释</th></tr></thead><tbody><tr><td>id</td><td>自增ID</td></tr><tr><td>uid</td><td>用户ID</td></tr><tr><td>item_id</td><td>商品ID</td></tr><tr><td>behavior_type</td><td>操作类型；1表示查看浏览；2表示收藏；3表示加购物车；4表示购买</td></tr><tr><td>user_geohash</td><td>用户地理位置哈希值</td></tr><tr><td>item_category</td><td>商品目录</td></tr><tr><td>visit_date</td><td>用户操作日期</td></tr><tr><td>province</td><td>用户所在省份</td></tr></tbody></table><div class=tbl-end style=height:10px></div><ol start=9><li>查询user表，查看是否有数据。</li></ol><pre><code>select * from db001.user001 limit 10;
</code></pre><ol start=10><li>完成以下 HiveQL 语句。</li></ol><p>（1）查询所有用户加购物车的次数。</p><pre><code>#结果
8560
</code></pre><p>（2）查询江浙沪（zhejiang，jiangsu，shanghai）用户购买物品的次数总和。</p><pre><code>#结果
305
</code></pre><p>（3）查询全部省份用户浏览次数，按次数从高到低排序。</p><pre><code>#结果
shanxi	16490
xinjiang	8525
tianjin	8490
zhejiang	8488
guangxi	8456
guangdong	8451
shanghai	8442
beijing	8431
hebei	8424
xianggang	8391
anhui	8390
hainan	8389
helongjiang	8379
qinghai	8370
fujian	8368
aomen	8354
neimenggu	8351
hunan	8337
gansu	8335
jilin	8327
xizang	8323
guizhou	8319
henan	8311
shandong	8309
liaoning	8296
yunnan	8272
jiangsu	8261
chongqing	8258
ningxia	8246
taiwan	8241
hubei	8192
jiangxi	8152
sichuan	8148
</code></pre><p>（4）查询用户收藏过并且购买了的商品的数量。</p><pre><code>#结果
427
</code></pre><blockquote><p>提示1：可以使用user001自己和自己连接。</p></blockquote><blockquote><p>提示2：注意这里前提是同一个用户，收藏并且购买。</p></blockquote><blockquote><p>提示3：用户收藏且购买的相同商品数量有可能有多个。例如用户（uid=103234309）收藏且购买的商品（item_id=395194106）有3个。</p></blockquote><p>（5）查询广东（guangdong）购物数量最多的前10位用户的ID和购物数量，按数量从高到低排序。</p><pre><code>102612580	5
101970481	5
101922121	4
103995979	3
102616570	3
101982646	3
10095384	3
</code></pre></div><div class=my-4><a href=/tags/%E5%95%86%E5%8A%A1%E6%99%BA%E8%83%BD/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#商务智能</a>
<a href=/tags/bi/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#bi</a>
<a href=/tags/%E8%AF%BE%E7%A8%8B/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#课程</a></div><div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t"><div id=presec><span class="block font-bold">上一页</span>
<a href=/docs/bi-exp/bi-exp03/ class=block>商务智能方法与应用第三章实验手册</a></div><div id=nextsec class="md:text-right mt-4 md:mt-0"><span class="block font-bold">下一页</span>
<a href=/docs/bi-exp/bi-exp01/ class=block>商务智能方法与应用第一章实验手册</a></div></div></div><div class="hidden lg:block lg:w-1/4"><div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-secondary-bg pt-16 -mt-16"><span class="text-lg font-semibold">本页内容</span></div><div class="sticky-toc hidden lg:block px-6 pb-6 pt-10 -mt-10 border-l"><nav id=TableOfContents><ul><li><a href=#实验手册版本>【实验手册版本】</a></li><li><a href=#实验21hive-数据仓库的建立和分析>实验2.1：Hive 数据仓库的建立和分析</a><ul><li><a href=#实验名称>【实验名称】</a></li><li><a href=#实验目的>【实验目的】</a></li><li><a href=#实验原理>【实验原理】</a></li><li><a href=#实验环境>【实验环境】</a></li><li><a href=#实验资源>【实验资源】</a></li><li><a href=#hive优化参数配置和解决常见问题>【Hive优化参数配置和解决常见问题】</a></li><li><a href=#实验步骤>【实验步骤】</a></li></ul></li></ul></nav></div><script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc();});</script></div></div></div></div></div><div id=outerdiv><div id=innerdiv><img id=bigimg src></div></div><script>document.addEventListener('DOMContentLoaded',()=>{hljs.highlightAll();hljs.initLineNumbersOnLoad({singleLine:true});changeSidebarHeight();switchDocToc();$("img").css("cursor:pointer")
$("img").click(function(){var _this=$(this);imgShow("#outerdiv","#innerdiv","#bigimg",_this);});$("ol").each(function(index){if(/\d{1,4}/.test($(this).attr("start"))){let idx=parseInt($(this).attr("start"));let lis=$(this).find("li");if(lis.length>0){lis.each(function(index){$(this).attr("id","step"+(idx+index));});}else{$(this).attr("id","step"+idx);}}});});</script><script src=/static/js/clipboard.min.js></script><script src=/static/js/codecopy.bundle.js?54></script></div></div></main><footer class=pl-scrollbar><div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2021 <a href=https://www.wangchucheng.com/>C. Wang</a> and <a href=https://www.ruiqima.com/>R. Ma</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>